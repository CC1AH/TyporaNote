[TOC]

### 一. 介绍

 1. 概念：

    控制和管理调度资源，并提供接口和环境。在裸机之上，目标是对于硬件机器的拓展。

    

 2. 功能：

     1. 作为系统资源的管理者：处理机（CPU）管理，存储器管理，文件管理，设备管理

     2. 作为用户和计算机硬件间的接口：提供命令接口和程序接口。

        a. 命令接口：分为联机命令接口（同步执行每句指令，比如cmd的time指令）和脱机/批处理命令接口（异步执行批次指令，比如.bat文件）。

        b. 程序接口：只能通过用户程序间接使用的接口（比如.DLL的系统调用），一般，系统调用=广义调用=程序接口。

        3. GUI
        
           

 3. 基本特征：

    1. 并发：两个或者多个事件在同一时间间隔内发生，并行是指多个事件在同一时刻同时发生

    2. 共享：系统中的资源可以供多个并发执行的进程共同使用

       a. 互斥共享：同一时间段只允许一个进程使用

       b. 同时共享：同一时间段允许多个进程使用

       并发和共享互为存在的条件

    3. 虚拟：把物理上的实体对应为若干逻辑上的对应物

       比如只有4G的内存可以支持运行内存总额大于4G软件同时运行（虚拟存储器和空分复用技术，以后会重点讲解）

    4. 异步：因为资源限制，进程执行不会一贯到底，而是不可预知的

       并发和共享是虚拟和异步的存在条件
       
       

 4. 发展和分类：

    1. 手工操作阶段

       处理速度快，输入输出极慢（人工输入打点带），资源利用率低。

    2. 单道批处理系统

       计算机依靠监督程序从磁带读入，提高了处理速度和资源利用率（就是一次处理许多指令），但是仍然是串行的。

    3. 多道批处理系统

       把多个磁带放进去。真正意义上的OS诞生，调度程序会调度所有输入磁带的执行，是最早的流水线（输入、计算、输出模块可以保证一直工作而不用一直等待）。缺点就是没有提供人机交互。整个作业过程是一个黑盒。

    4. 分时操作系统

       计算机以时间片为单位轮流为用户作业/服务，用户可以通过终端与计算机交互。但是没有任务优先级。

    5. 实时操作系统

       能够相应一些紧急的任务，不需要时间片排队，保证了及时性和可靠性。按照是否允许小的时间规定差异分为硬实时系统（飞控）和软实时系统（抢票）。

    6. 其他：网络OS 分布式OS 个人OS
    
       

### 二. 指令分类、中断和异常、系统调用

1. 指令和内核的分类：

   A 特权指令（处于核心态，往往是内核程序在负责运行该种指令，可以执行如内存清零等操作）

   B 非特权指令（处于用户态，不能执行特权指令）。

   一般的，临近硬件层次的内核负责的相关功能（时钟管理，中断管理和原语（一种特殊的程序，最接近硬件的具有原子性的程序，如设备驱动，CPU切换等）、【进程管理，存储器管理，设备管理】等）一般使用特权指令定义。一些操作系统并不把方括号内的功能放到内核中，我们称之为微内核，反之称之为大内核。

   微内核内核功能少维护方便，但是需要频繁切换两态，性能就相对低。各有优劣。

   

2. 两态判断：

   使用PSW（程序状态寄存器）中的某个位来判断是在 哪个态

   

3. 中断是什么：

   中断的本质是指发生即需要OS介入开展管理工作，流程是CPU收到计时部件发出的中断信号，切换为核心态由OS内核对中断进行处理，切换进程运行。

   **重复一遍，当中断发生，CPU立即进入核心态，当前进程立即停止运行。并由OS内核进行处理。并且，中断是用户态到核心态的唯一途径。**

   而核心态到用户态只需要执行设置PSW（程序状态字）的特权指令即可

   

4. 中断的分类

   A. 内中断-中断信号来源于CPU内部，也称为异常、例外、陷入。分为指令中断（系统调用）和强迫中断（硬件故障（缺页）或者软件中断（除以0））

   *也可以分为陷入（有意的，如系统调用），故障（如缺页），终止（不可恢复的错误）*

   B. 外中断-信号来源于CPU外部，狭义概念上的中断。包括外设请求（如IO）和人工干预（如用户终止）两方面。CPU在执行完每条指令之后都需要检查外部中断信号。如果检测到，需要保护被中断进程的CPU环境，之后根据中断信号类型转入中断处理程序，运行完成后恢复环境即可。

   

5. 系统调用

   OS面向用户的接口称为命令接口，那么**面向应用程序的接口则称之为程序接口，又称系统调用，它实现的是对资源的控制，必须在核心态完成**；凡是和资源相关的都需要使用系统调用，高级语言（如C）的某些库函数封装了系统调用，因此开发者系统调用往往使用这种形式

   ```
   //举例: write()
   编译执行汇编，将参数放入寄存器mov，之后执行trap指令int导致切换到核心态。
   ```

   因此核心态下唯一一个不能执行的指令是陷入指令

   

### 三.进程

 1. 背景

    计算机中出现多道程序的数据存放和并发执行的需求。为准确找到各个程序的存放位置。操作系统为每个运行的程序配置称之为PCB（进程控制块）的数据结构，用来存放诸如程序代码位置之类的信息。

	2. 定义

    进程实体包括程序段（指令序列）、数据段、PCB，他被简称为进程（n）。创建和撤销进程，就是PCB的创消过程，**PCB是进程存在的唯一标志**。

    我们可以说，进程（v）是进程实体的运行过程，是程序的一次执行过程，是**系统资源分配的调度的基本单位**，它的核心特性在于**动态性**

    综上，进程拥有动态性 独立性 并发性 异步性 结构性

	3. PCB的组成

    进程描述信息（进程标识符PID和用户标识符UID）、 进程控制和管理信息（当前状态和优先级）、资源分配清单、处理机相关信息（各种寄存器值，用于恢复结果）

	4. 进程的组织

    多个进程间的组织方式分为两种类型

    链接方式-按照进程状态将PCB分为几个队列，OS持有指向各个队列的指针（比如执行指针、就绪队列指针、阻塞队列指针）

    索引方式-根据进程状态分为几个索引表，OS持有指向各个索引表的指针

	5. 进程的状态

    三种基本状态：运行态（处理机处理中）、就绪态（已经**拥有除了处理机（CPU）**外的所有资源）、阻塞态（所**需除处理机的其他资源**被其他响应占用）

    两种额外状态：创建态（资源分配和PCB初始化等）、终止态（资源等的释放中）

    **状态转换**

    ![三态](./img/三态.png)

    A. 运行态到阻塞态是主动行为（主动请求资源而未得），阻塞态到就绪态是被动行为（资源被他方释放）。

    B. 阻塞态和运行态不能直接转换。

	6. 进程的控制







